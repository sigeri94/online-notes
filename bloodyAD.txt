 bloodyAD --host 192.168.88.122 -d gotham.local -u alfred -p 'P@ssw0rd' get search \
  --filter "(msDS-AllowedToDelegateTo=*)" \
  --attr "sAMAccountName,msDS-AllowedToDelegateTo"


distinguishedName: CN=WEB01,CN=Computers,DC=gotham,DC=local
msDS-AllowedToDelegateTo: cifs/FILE01; cifs/file01.gotham.local
sAMAccountName: WEB01$

distinguishedName: CN=JMP01,CN=Computers,DC=gotham,DC=local
msDS-AllowedToDelegateTo: cifs/FILE01; cifs/file01.gotham.local
sAMAccountName: JMP01$

distinguishedName: CN=FILE01,CN=Computers,DC=gotham,DC=local
msDS-AllowedToDelegateTo: web01$
sAMAccountName: FILE01$


| sAMAccountName | Delegates To (SPNs or Principals)   | Type (Likely)                         |
| WEB01$         | cifs/FILE01cifs/file01.gotham.local | Constrained Delegation (Kerberos S4U) |
| JMP01$         | cifs/FILE01cifs/file01.gotham.local | Constrained Delegation (Kerberos S4U) |
| FILE01$        | web01$ (a computer account)         | RBCD (Resource-Based Constrained Delegation) |


bloodyAD --host 192.168.88.122 -d gotham.local -u alfred -p 'P@ssw0rd' get search \
  --filter "(msDS-AllowedToActOnBehalfOfOtherIdentity=*)" \
  --attr "sAMAccountName,msDS-AllowedToActOnBehalfOfOtherIdentity"


distinguishedName: CN=ARKHAM,CN=Computers,DC=gotham,DC=local
msDS-AllowedToActOnBehalfOfOtherIdentity: O:S-1-5-32-544D:(A;;0xf01ff;;;S-1-5-21-992210110-3485122186-159714507-1117)
sAMAccountName: ARKHAM$


| sAMAccountName (Target) | Trusted SID (Impersonator) | Type | SID Meaning |
| ARKHAM$ | S-1-5-21-992210110-3485122186-159714507-1117 | RBCD (Inbound Trust) | Likely a computer account (e.g. WEB01$) |


bloodyAD --host 192.168.88.122 -d gotham.local -u alfred -p 'P@ssw0rd' get search \
  --filter "(objectSID=S-1-5-21-992210110-3485122186-159714507-1117)" \
  --attr "sAMAccountName,distinguishedName"


distinguishedName: CN=WEB01,CN=Computers,DC=gotham,DC=local
sAMAccountName: WEB01$



| Impersonator | Target | Delegation Type |
| WEB01$      | ARKHAM$ | RBCD            |


â””â”€$ bloodyAD --host 192.168.88.122 -d gotham.local -u alfred -p 'P@ssw0rd' get search \
  --filter "(|(&(userAccountControl:1.2.840.113556.1.4.803:=524288))(&(userAccountControl:1.2.840.113556.1.4.803:=16777216))(msDS-AllowedToDelegateTo=*))" \
  --attr "sAMAccountName,userAccountControl,msDS-AllowedToDelegateTo"


distinguishedName: CN=Administrator,CN=Users,DC=gotham,DC=local
sAMAccountName: Administrator
userAccountControl: NORMAL_ACCOUNT; DONT_EXPIRE_PASSWORD; TRUSTED_FOR_DELEGATION

distinguishedName: CN=DC07,OU=Domain Controllers,DC=gotham,DC=local
sAMAccountName: DC07$
userAccountControl: SERVER_TRUST_ACCOUNT; TRUSTED_FOR_DELEGATION

distinguishedName: CN=WEB01,CN=Computers,DC=gotham,DC=local
msDS-AllowedToDelegateTo: cifs/FILE01; cifs/file01.gotham.local
sAMAccountName: WEB01$
userAccountControl: WORKSTATION_TRUST_ACCOUNT; TRUSTED_TO_AUTH_FOR_DELEGATION

distinguishedName: CN=JMP01,CN=Computers,DC=gotham,DC=local
msDS-AllowedToDelegateTo: cifs/FILE01; cifs/file01.gotham.local
sAMAccountName: JMP01$
userAccountControl: WORKSTATION_TRUST_ACCOUNT

distinguishedName: CN=FILE01,CN=Computers,DC=gotham,DC=local
msDS-AllowedToDelegateTo: web01$
sAMAccountName: FILE01$
userAccountControl: WORKSTATION_TRUST_ACCOUNT


| Account       | UAC Flags                                                    | Delegation Type                                                        | Delegates To |
| Administrator | NORMAL_ACCOUNT; DONT_EXPIRE_PASSWORD; TRUSTED_FOR_DELEGATION | ðŸŸ¥ Unconstrained Delegation                                            | Any service, any user |
| DC07$         | SERVER_TRUST_ACCOUNT; TRUSTED_FOR_DELEGATION                 | ðŸŸ¥ Unconstrained Delegation (DC default)                               | Any service, any user |
| WEB01$        | WORKSTATION_TRUST_ACCOUNT; TRUSTED_TO_AUTH_FOR_DELEGATION    | ðŸŸ§ Constrained Delegation + Protocol Transition (S4U2Self + S4U2Proxy) | cifs/FILE01, cifs/file01.gotham.local |
| JMP01$        | WORKSTATION_TRUST_ACCOUNT                                    | ðŸŸ¨ Constrained Delegation (S4U2Proxy only)                             | cifs/FILE01, cifs/file01.gotham.local |
| FILE01$       | WORKSTATION_TRUST_ACCOUNT                                    | ðŸŸ¦ Resource-Based Constrained Delegation (RBCD)                        | Trusts web01$ to impersonate users to it |



| Em | Type                               | Attack Scenario |
| ðŸŸ¥ | Unconstrained Delegation          | If attacker gets TGT on these machines, they can impersonate any user to any service (Golden Ticket or TGT replay). |
| ðŸŸ§ | Constrained + Protocol Transition | Can impersonate users without knowing their creds via S4U2Self â†’ S4U2Proxy. Great for Rubeus s4u. |
| ðŸŸ¨ | Constrained Delegation            | Can impersonate only already-authenticated users to specific SPNs. |
| ðŸŸ¦ | RBCD                              | If attacker controls WEB01$, they can impersonate anyone to FILE01$. |


